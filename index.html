<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Albuquerque Site Selection - Interactive Model</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Heatmap JS -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        /* Weight Control Panel */
        .weight-control {
            position: absolute;
            bottom: 50px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 320px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .weight-control {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                max-width: 100%;
                border-radius: 20px 20px 0 0;
                max-height: 50vh;
            }
        }
        
        .weight-control h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .slider-group {
            margin-bottom: 12px;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 3px;
            color: #34495e;
            font-size: 13px;
            font-weight: 600;
        }
        
        .slider-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .slider-value {
            display: inline-block;
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            float: right;
        }
        
        .weight-sum {
            text-align: center;
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
        }
        
        .weight-sum.valid {
            background: #d4edda;
            color: #155724;
        }
        
        .weight-sum.invalid {
            background: #f8d7da;
            color: #721c24;
        }
        
        .update-button {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .update-button:hover {
            background: #2980b9;
        }
        
        .update-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #1565c0;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            line-height: 18px;
            color: #555;
        }
        
        .legend h4 {
            margin: 0 0 10px;
            font-size: 14px;
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 10000;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Loading map data...</div>
    <div id="map"></div>
    
    <!-- Weight Control Panel -->
    <div class="weight-control">
        <h2> Live Model Explorer</h2>
        
        <div class="info-box">
            <strong>üéØ Focus Area: Albuquerque</strong><br>
            Adjust weights to see how scoring changes in real-time!<br>
            <small>Threshold filters top sites only - calculation takes 5-10s</small>
        </div>
        
        <div class="slider-group">
            <label>
                üçî Fast Food 
                <span class="slider-value" id="val-fastfood">0.30</span>
            </label>
            <input type="range" id="weight-fastfood" min="0" max="1" step="0.01" value="0.30">
        </div>
        
        <div class="slider-group">
            <label>
                üõ£Ô∏è Highway 
                <span class="slider-value" id="val-highway">0.30</span>
            </label>
            <input type="range" id="weight-highway" min="0" max="1" step="0.01" value="0.30">
        </div>
        
        <div class="slider-group">
            <label>
                üö¶ Traffic Volume
                <span class="slider-value" id="val-traffic">0.23</span>
            </label>
            <input type="range" id="weight-traffic" min="0" max="1" step="0.01" value="0.23">
        </div>
        
        <div class="slider-group">
            <label>
                üßîüèΩ‚Äç‚ôÇÔ∏è Diversity Index
                <span class="slider-value" id="val-diversity">0.07</span>
            </label>
            <input type="range" id="weight-diversity" min="0" max="1" step="0.01" value="0.07">
        </div>
        
        <div class="slider-group">
            <label>
                üéì Unis & Malls
                <span class="slider-value" id="val-poi">0.10</span>
            </label>
            <input type="range" id="weight-poi" min="0" max="1" step="0.01" value="0.10">
        </div>
        
        <div class="slider-group">
            <label>
                üíØ Score Threshold
                <span class="slider-value" id="val-threshold">0.50</span>
            </label>
            <input type="range" id="threshold-slider" min="0" max="1" step="0.01" value="0.50">
        </div>
        
        <div class="weight-sum" id="weightSum">Weight Sum: 1.00</div>
        
        <button class="update-button" id="updateButton" onclick="recalculateScores()">
            üîÑ Recalculate Scores
        </button>
        
        <div style="margin-top: 10px; font-size: 11px; color: #7f8c8d; text-align: center;">
            Calculation takes ~5-10 seconds<br>
            <span style="font-size: 10px;">Grid: ~6,400 points at 0.5km resolution</span>
        </div>
    </div>
    
    <script>
        // ============================================
        // ALBUQUERQUE FOCUS AREA
        // ============================================
        
        const ABQ_BOUNDS = {
            minLat: 34.9,
            maxLat: 35.3,
            minLon: -106.8,
            maxLon: -106.4
        };
        
        const ABQ_CENTER = [35.0844, -106.6504];
        
        const CONFIG = {
            RESOLUTION: 0.005,  // ~0.5km grid = much denser heatmap (was 0.02 = 2km)
            DECAY_K: 0.05,
            DISTRIBUTION_CENTERS: [
                {lat: 39.09820436455732, lon: -104.78195183701729, name: 'Denver, CO'},
                {lat: 33.54855180837709, lon: -112.00158827551459, name: 'Phoenix, AZ'}
            ],
            DC_RADIUS_KM: 300 * 1.609,
            TRAFFIC_MIN_THRESHOLD: 5000
        };
        
        // Global data storage (filtered to Albuquerque)
        let abqData = {
            fastFood: [],
            highways: [],
            pois: [],
            trafficStations: [],
            roadTraffic: [],
            diversity: []
        };
        
        // ============================================
        // INITIALIZE MAP
        // ============================================
        
        const map = L.map('map', {
            center: ABQ_CENTER,
            zoom: 11
        });
        
        const baseLayers = {
            "Street Map": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }),
            "Dark Base Map": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                maxZoom: 19
            })
        };
        
        baseLayers["Street Map"].addTo(map);
        
        const overlayLayers = {
            stateBoundary: L.featureGroup(),
            streetNetwork: L.featureGroup(),
            fastFood: L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                spiderfyOnMaxZoom: true,
                disableClusteringAtZoom: 15
            }),
            poisMallsUnis: L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true
            }),
            trafficStations: L.markerClusterGroup({
                showCoverageOnHover: false
            }),
            avgTraffic: L.featureGroup(),
            dcRadius: L.featureGroup().addTo(map),
            diversityData: L.featureGroup().addTo(map),
            abqBoundary: L.featureGroup().addTo(map),
            scoringMap: L.featureGroup().addTo(map),
            topLocations: L.featureGroup().addTo(map)
        };
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        
        function isInAlbuquerque(lat, lon) {
            return lat >= ABQ_BOUNDS.minLat && lat <= ABQ_BOUNDS.maxLat &&
                   lon >= ABQ_BOUNDS.minLon && lon <= ABQ_BOUNDS.maxLon;
        }
        
        function getTrafficColor(traffic) {
            if (traffic > 50000) return '#dc2626';
            if (traffic > 20000) return '#ea580c';
            if (traffic > 10000) return '#f59e0b';
            if (traffic > 5000) return '#84cc16';
            if (traffic > 1000) return '#22c55e';
            return '#6e8ab7';
        }
        
        function getTrafficWeight(traffic) {
            if (traffic > 50000) return 5;
            if (traffic > 20000) return 4;
            if (traffic > 10000) return 3;
            return 2;
        }
        
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function minDistanceToPoints(lat, lon, points, k = 1) {
            // Get k closest points and return average distance
            const distances = [];
            
            for (const point of points) {
                const dist = haversineDistance(lat, lon, point.lat, point.lon);
                distances.push(dist);
            }
            
            if (distances.length === 0) return 100;
            
            // Sort and take k closest
            distances.sort((a, b) => a - b);
            const closest = distances.slice(0, Math.min(k, distances.length));
            
            // Return average distance
            return closest.reduce((sum, d) => sum + d, 0) / closest.length;
        }
        
        function minDistanceToLines(lat, lon, lines) {
            let minDist = Infinity;
            for (const line of lines) {
                for (const point of line) {
                    const dist = haversineDistance(lat, lon, point.lat, point.lon);
                    if (dist < minDist) minDist = dist;
                }
            }
            return minDist === Infinity ? 100 : minDist;
        }
        
        // ============================================
        // DATA LOADING (FILTERED TO ALBUQUERQUE)
        // ============================================
        
        async function loadFastFoodLocations() {
            try {
                const response = await fetch('fast_food_locations.json');
                if (!response.ok) throw new Error('Fast food data not found');
                
                const allLocations = await response.json();
                
                // Filter to Albuquerque
                abqData.fastFood = allLocations.filter(loc => 
                    isInAlbuquerque(loc.lat, loc.lon)
                );
                
                abqData.fastFood.forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lon], {
                        icon: L.divIcon({
                            html: '<i class="fas fa-utensils" style="color: red; font-size: 16px;"></i>',
                            className: 'custom-div-icon',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    marker.bindPopup(`<b>${loc.name}</b><br>Rating: ${loc.rating || 'N/A'}`);
                    overlayLayers.fastFood.addLayer(marker);
                });
                
                console.log(`‚úì Fast Food in ABQ: ${abqData.fastFood.length} locations`);
            } catch (e) {
                console.log('Fast food data not available');
            }
        }
        
        async function loadHighways() {
            try {
                const response = await fetch('highways.geojson');
                if (!response.ok) throw new Error('Highway data not found');
                
                const data = await response.json();
                
                // Extract line coordinates in ABQ
                data.features.forEach(feature => {
                    if (feature.geometry.type === 'LineString') {
                        const coords = feature.geometry.coordinates;
                        const abqCoords = coords.filter(coord => 
                            isInAlbuquerque(coord[1], coord[0])
                        );
                        if (abqCoords.length > 0) {
                            abqData.highways.push(abqCoords.map(c => ({lat: c[1], lon: c[0]})));
                        }
                    }
                });
                
                // Display highways
                L.geoJSON(data, {
                    style: {
                        color: '#5f6268',
                        weight: 1,
                        opacity: 0.5
                    },
                    filter: function(feature) {
                        // Only show if intersects ABQ
                        if (feature.geometry.type === 'LineString') {
                            return feature.geometry.coordinates.some(coord =>
                                isInAlbuquerque(coord[1], coord[0])
                            );
                        }
                        return false;
                    }
                }).addTo(overlayLayers.streetNetwork);
                
                console.log(`‚úì Highways in ABQ: ${abqData.highways.length} segments`);
            } catch (e) {
                console.log('Highway data not available');
            }
        }
        
        async function loadPOIs() {
            try {
                const response = await fetch('poi_locations.json');
                if (!response.ok) throw new Error('POI data not found');
                
                const allPOIs = await response.json();
                
                // Filter to Albuquerque
                abqData.pois = allPOIs.filter(poi => 
                    isInAlbuquerque(poi.lat, poi.lon)
                );
                
                abqData.pois.forEach(poi => {
                    const marker = L.marker([poi.lat, poi.lon], {
                        icon: L.divIcon({
                            html: '<i class="fas fa-circle-dot" style="color: purple; font-size: 14px;"></i>',
                            className: 'custom-div-icon',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    marker.bindPopup(`<b>${poi.name}</b>`);
                    overlayLayers.poisMallsUnis.addLayer(marker);
                });
                
                console.log(`‚úì POIs in ABQ: ${abqData.pois.length} locations`);
            } catch (e) {
                console.log('POI data not available');
            }
        }
        
        async function loadTrafficStations() {
            try {
                const response = await fetch('traffic_stations.json');
                if (!response.ok) throw new Error('Traffic stations not found');
                
                const allStations = await response.json();
                
                // Filter to Albuquerque
                abqData.trafficStations = allStations.filter(station => 
                    isInAlbuquerque(station.lat, station.lon)
                );
                
                abqData.trafficStations.forEach(station => {
                    const marker = L.marker([station.lat, station.lon], {
                        icon: L.divIcon({
                            html: '<i class="fas fa-taxi" style="color: lightblue; font-size: 16px;"></i>',
                            className: 'custom-div-icon',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    marker.bindPopup(`<b>Traffic Station</b><br>Count: ${station.count.toLocaleString()}`);
                    overlayLayers.trafficStations.addLayer(marker);
                });
                
                console.log(`‚úì Traffic Stations in ABQ: ${abqData.trafficStations.length} stations`);
            } catch (e) {
                console.log('Traffic station data not available');
            }
        }
        
        async function loadRoadTraffic() {
            try {
                const response = await fetch('road_traffic.geojson');
                if (!response.ok) throw new Error('Road traffic not found');
                
                const data = await response.json();
                
                // Filter and store road traffic data for ABQ
                data.features.forEach(feature => {
                    if (feature.geometry.type === 'LineString') {
                        const coords = feature.geometry.coordinates;
                        const abqCoords = coords.filter(coord => 
                            isInAlbuquerque(coord[1], coord[0])
                        );
                        if (abqCoords.length > 0) {
                            const traffic = feature.properties.mean_traffic || feature.properties.traffic;
                            abqData.roadTraffic.push({
                                coords: abqCoords.map(c => ({lat: c[1], lon: c[0]})),
                                traffic: traffic
                            });
                        }
                    }
                });
                
                L.geoJSON(data, {
                    style: function(feature) {
                        const traffic = feature.properties.mean_traffic || feature.properties.traffic;
                        return {
                            color: getTrafficColor(traffic),
                            weight: getTrafficWeight(traffic),
                            opacity: 0.8
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const traffic = feature.properties.mean_traffic || feature.properties.traffic;
                        layer.bindPopup(`<b>Avg. Traffic</b><br>Volume: ${traffic ? traffic.toLocaleString() : 'N/A'} vehicles/day`);
                    },
                    filter: function(feature) {
                        if (feature.geometry.type === 'LineString') {
                            const hasABQ = feature.geometry.coordinates.some(coord =>
                                isInAlbuquerque(coord[1], coord[0])
                            );
                            const traffic = feature.properties.mean_traffic || feature.properties.traffic;
                            return hasABQ && traffic > CONFIG.TRAFFIC_MIN_THRESHOLD;
                        }
                        return false;
                    }
                }).addTo(overlayLayers.avgTraffic);
                
                console.log(`‚úì Road Traffic in ABQ: ${abqData.roadTraffic.length} segments`);
            } catch (e) {
                console.error('Road traffic loading error:', e);
            }
        }
        
        function loadDistributionCenters() {
            CONFIG.DISTRIBUTION_CENTERS.forEach((dc, idx) => {
                L.marker([dc.lat, dc.lon], {
                    icon: L.divIcon({
                        html: '<i class="fas fa-truck" style="color: blue; font-size: 20px;"></i>',
                        className: 'custom-div-icon',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).bindPopup(`<b>Distribution Center ${idx + 1}</b><br>${dc.name}`)
                  .addTo(overlayLayers.dcRadius);
                
                L.circle([dc.lat, dc.lon], {
                    radius: CONFIG.DC_RADIUS_KM * 1000,
                    color: 'blue',
                    fillColor: '#d84444',
                    fillOpacity: 0.1,
                    weight: 2
                }).addTo(overlayLayers.dcRadius);
            });
            
            console.log('‚úì Distribution Centers loaded');
        }
        
        function loadABQBoundary() {
            // Draw Albuquerque focus boundary
            L.rectangle([
                [ABQ_BOUNDS.minLat, ABQ_BOUNDS.minLon],
                [ABQ_BOUNDS.maxLat, ABQ_BOUNDS.maxLon]
            ], {color: '#888888', weight: 1, fillOpacity: 0.02 }
                       )
                .bindPopup('<b>Albuquerque Focus Area</b><br>Scoring calculated within this boundary')
              .addTo(overlayLayers.abqBoundary);
        }
        
        async function loadDiversityData() {
            try {
                const response = await fetch('diversity_data.geojson');
                if (!response.ok) throw new Error('Diversity data not found');
                
                const data = await response.json();
                
                // Filter to ABQ and extract centroids with population
                data.features.forEach(feature => {
                    const geom = feature.geometry;
                    let centroid;
                    
                    if (geom.type === 'Polygon') {
                        const coords = geom.coordinates[0];
                        const lats = coords.map(c => c[1]);
                        const lons = coords.map(c => c[0]);
                        centroid = {
                            lat: lats.reduce((a,b) => a+b) / lats.length,
                            lon: lons.reduce((a,b) => a+b) / lons.length
                        };
                    }
                    
                    if (centroid && isInAlbuquerque(centroid.lat, centroid.lon)) {
                        const pop = feature.properties['Total:‚ÄîEstimate'];
                        if (pop && pop > 0) {
                            abqData.diversity.push({
                                lat: centroid.lat,
                                lon: centroid.lon,
                                population: pop
                            });
                        }
                    }
                });
                
                console.log(`‚úì Diversity data in ABQ: ${abqData.diversity.length} census tracts`);
            } catch (e) {
                console.log('Diversity data not available - using placeholder');
            }
        }
        
        // ============================================
        // REAL-TIME SCORING CALCULATION
        // ============================================
        
        function calculateScores(weights, threshold) {
            console.log('üîÑ Calculating scores for Albuquerque...');
            console.time('Scoring');
            
            const gridPoints = [];
            
            // Create DENSE grid over Albuquerque
            for (let lat = ABQ_BOUNDS.minLat; lat < ABQ_BOUNDS.maxLat; lat += CONFIG.RESOLUTION) {
                for (let lon = ABQ_BOUNDS.minLon; lon < ABQ_BOUNDS.maxLon; lon += CONFIG.RESOLUTION) {
                    gridPoints.push({lat, lon});
                }
            }
            
            console.log(`Grid size: ${gridPoints.length} points (dense coverage for smooth heatmap)`);
            
            const scores = [];
            let progressCount = 0;
            const progressInterval = Math.floor(gridPoints.length / 10); // Update every 10%
            
            // Calculate score for each grid point
            gridPoints.forEach((point, idx) => {
                // Progress logging
                if (idx % progressInterval === 0) {
                    progressCount++;
                    console.log(`Progress: ${(progressCount * 10)}%`);
                }
                
                // 1. Fast Food proximity (5 closest locations)
                const ffDist = minDistanceToPoints(point.lat, point.lon, abqData.fastFood, 5);
                const ffScore = Math.exp(-CONFIG.DECAY_K * ffDist);
                
                // 2. Highway proximity
                const hwDist = minDistanceToLines(point.lat, point.lon, abqData.highways);
                const hwScore = Math.exp(-CONFIG.DECAY_K * hwDist);
                
                // 3. Traffic score (weighted by traffic volume)
                let trafficScore = 0;
                if (abqData.roadTraffic.length > 0) {
                    let closestTrafficDist = Infinity;
                    let closestTrafficValue = 0;
                    
                    for (const road of abqData.roadTraffic) {
                        for (const coord of road.coords) {
                            const dist = haversineDistance(point.lat, point.lon, coord.lat, coord.lon);
                            if (dist < closestTrafficDist) {
                                closestTrafficDist = dist;
                                closestTrafficValue = road.traffic;
                            }
                        }
                    }
                    
                    // Normalize traffic (assuming max ~100,000)
                    const normalizedTraffic = Math.min(closestTrafficValue / 100000, 1);
                    trafficScore = Math.exp(-CONFIG.DECAY_K * closestTrafficDist) * normalizedTraffic;
                }
                
                // 4. Diversity score (from census tract population)
                let divScore = 0;
                if (abqData.diversity.length > 0) {
                    // Find closest census tract and get normalized population with decay
                    let closestDist = Infinity;
                    let closestPop = 0;
                    
                    for (const tract of abqData.diversity) {
                        const dist = haversineDistance(point.lat, point.lon, tract.lat, tract.lon);
                        if (dist < closestDist) {
                            closestDist = dist;
                            closestPop = tract.population;
                        }
                    }
                    
                    // Normalize population (assume max ~10000)
                    const normalizedPop = Math.min(closestPop / 10000, 1);
                    // Apply decay
                    const decayFactor = Math.exp(-0.1 * closestDist);
                    divScore = normalizedPop * decayFactor;
                } else {
                    divScore = 0.5; // Fallback
                }
                
                // 5. POI proximity
                const poiDist = minDistanceToPoints(point.lat, point.lon, abqData.pois);
                const poiScore = Math.exp(-CONFIG.DECAY_K * poiDist);
                
                // Calculate weighted final score
                const finalScore = 
                    weights.fastfood * ffScore +
                    weights.highway * hwScore +
                    weights.traffic * trafficScore +
                    weights.diversity * divScore +
                    weights.poi * poiScore;
                
                scores.push({
                    lat: point.lat,
                    lon: point.lon,
                    score: finalScore
                });
            });
            
            // Filter by threshold
            const aboveThreshold = scores.filter(s => s.score > threshold);
            aboveThreshold.sort((a, b) => b.score - a.score);
            
            console.timeEnd('Scoring');
            console.log(`‚úì ${aboveThreshold.length} points above threshold ${threshold} (of ${scores.length} total)`);
            console.log(`Score range: ${Math.min(...scores.map(s => s.score)).toFixed(4)} to ${Math.max(...scores.map(s => s.score)).toFixed(4)}`);
            
            return {
                all: scores,
                aboveThreshold: aboveThreshold,
                topSites: aboveThreshold.slice(0, 10)
            };
        }
        
        function displayScoring(results) {
            // Clear existing
            overlayLayers.scoringMap.clearLayers();
            overlayLayers.topLocations.clearLayers();
            
            // Use ALL scores for heatmap (not just above threshold)
            // This shows the full range from worst to best
            const allScores = results.all;
            
            if (allScores.length === 0) {
                alert('No scores calculated!');
                return;
            }
            
            // Find min and max scores across ALL points
            const scores = allScores.map(s => s.score);
            const minScore = Math.min(...scores);
            const maxScore = Math.max(...scores);
            const scoreRange = maxScore - minScore;
            
            console.log(`Full score range: ${minScore.toFixed(4)} to ${maxScore.toFixed(4)}`);
            console.log(`Using ALL ${allScores.length} points for heatmap`);
            
            // Normalize scores to 0-1 range for color distribution
            const heatmapData = allScores.map(s => {
                const normalizedScore = scoreRange > 0 ? (s.score - minScore) / scoreRange : 0.5;
                return [s.lat, s.lon, normalizedScore];
            });
            
            L.heatLayer(heatmapData, {
                radius: 15,
                blur: 20,
                maxZoom: 15,
                max: 1.0,
                minOpacity: 0.1,
                gradient: {
                    0.0: 'blue',      // Lowest scores (worst locations)
                    0.2: 'cyan',
                    0.4: 'lime',
                    0.6: 'yellow',
                    0.8: 'orange',
                    1.0: 'red'        // Highest scores (best locations)
                }
            }).addTo(overlayLayers.scoringMap);
            
            // Top sites come from threshold-filtered results
            if (results.topSites && results.topSites.length > 0) {
                results.topSites.forEach((site, idx) => {
                    L.marker([site.lat, site.lon], {
                        icon: L.divIcon({
                            html: `<div style="background: green; color: white; padding: 5px; border-radius: 50%; width: 25px; height: 25px; text-align: center; line-height: 15px; font-weight: bold; border: 2px solid white;">${idx + 1}</div>`,
                            className: 'top-site-marker',
                            iconSize: [25, 25],
                            iconAnchor: [12, 12]
                        })
                    }).bindPopup(`
                        <b>Top Site #${idx + 1}</b><br>
                        Score: ${site.score.toFixed(4)}<br>
                        Location: ${site.lat.toFixed(4)}, ${site.lon.toFixed(4)}
                    `).addTo(overlayLayers.topLocations);
                });
                
                console.log(`‚úì Displayed ${results.topSites.length} top sites (above threshold: ${results.aboveThreshold.length})`);
            } else {
                console.log('‚ö†Ô∏è No sites above threshold - consider lowering it');
            }
            
            console.log(`‚úì Heatmap shows full score distribution (blue=worst, red=best)`);
        }
        
        // ============================================
        // WEIGHT CONTROLS
        // ============================================
        
        const sliders = ['fastfood', 'highway', 'traffic', 'diversity', 'poi', 'threshold'];
        sliders.forEach(name => {
            const slider = document.getElementById(`weight-${name}`) || document.getElementById(`${name}-slider`);
            const display = document.getElementById(`val-${name}`);
            
            slider.addEventListener('input', function() {
                display.textContent = parseFloat(this.value).toFixed(2);
                updateWeightSum();
            });
        });
        
        function updateWeightSum() {
            const sum = parseFloat(document.getElementById('weight-fastfood').value) +
                       parseFloat(document.getElementById('weight-highway').value) +
                       parseFloat(document.getElementById('weight-traffic').value) +
                       parseFloat(document.getElementById('weight-diversity').value) +
                       parseFloat(document.getElementById('weight-poi').value);
            
            const sumDisplay = document.getElementById('weightSum');
            sumDisplay.textContent = `Weight Sum: ${sum.toFixed(2)}`;
            sumDisplay.className = 'weight-sum ' + (Math.abs(sum - 1.0) < 0.01 ? 'valid' : 'invalid');
            
            document.getElementById('updateButton').disabled = Math.abs(sum - 1.0) >= 0.01;
        }
        
        function recalculateScores() {
            const weights = {
                fastfood: parseFloat(document.getElementById('weight-fastfood').value),
                highway: parseFloat(document.getElementById('weight-highway').value),
                traffic: parseFloat(document.getElementById('weight-traffic').value),
                diversity: parseFloat(document.getElementById('weight-diversity').value),
                poi: parseFloat(document.getElementById('weight-poi').value)
            };
            
            const threshold = parseFloat(document.getElementById('threshold-slider').value);
            
            document.getElementById('updateButton').textContent = '‚è≥ Calculating...';
            document.getElementById('updateButton').disabled = true;
            
            setTimeout(() => {
                const results = calculateScores(weights, threshold);
                displayScoring(results);
                
                document.getElementById('updateButton').textContent = 'üîÑ Recalculate Scores';
                updateWeightSum(); // Re-enable button if valid
            }, 100);
        }
        
        // ============================================
        // LEGENDS
        // ============================================
        
        // ============================================
        // LAYER CONTROL
        // ============================================
        
        const layerControl = L.control.layers(baseLayers, {
            'Street Network': overlayLayers.streetNetwork,
            'Competition: Fast Food': overlayLayers.fastFood,
            'Unis/College/Malls': overlayLayers.poisMallsUnis,
            'Traffic Counts Station': overlayLayers.trafficStations,
            'Avg. Traffic': overlayLayers.avgTraffic,
            'DC Service Radius (300 mn)': overlayLayers.dcRadius,
            'Albuquerque Boundary': overlayLayers.abqBoundary,
            'ScoringMap': overlayLayers.scoringMap,
            'Top Identified Locations': overlayLayers.topLocations
        }, {
            collapsed: false
        }).addTo(map);
        
        // ============================================
        // INITIALIZE
        // ============================================
        
        async function loadAllData() {
            document.getElementById('loading').style.display = 'block';
            
            await Promise.all([
                loadFastFoodLocations(),
                loadHighways(),
                loadPOIs(),
                loadTrafficStations(),
                loadRoadTraffic(),
                loadDiversityData()
            ]);
            
            loadDistributionCenters();
            loadABQBoundary();
            updateWeightSum();
            
            document.getElementById('loading').style.display = 'none';
            console.log('‚úì All Albuquerque data loaded successfully');
            
            // Auto-calculate with default weights
            console.log('Auto-calculating initial scores...');
            recalculateScores();
        }
        
        loadAllData();
    </script>
</body>
</html>
